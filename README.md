# Vision-based robot manipulation: 6DoF pose estimation in a ROS 2 system
## University of Sk√∂vde | Hampus Hjalmarsson & Kevin Karlsson

### Prerequisites
Ubuntu 22.04 LTS  
ROS2 Humble  
Python 3.10  

***potential python packages not managed by rosdep  
OpenCV  
open3D  
ur-rtde  
scipy***
### Installation
- Create a ROS2 workspace:
  ```bash
  mkdir -p ~/ros2_ws/src
  cd ~/ros2_ws/src/
  ```

- Install Intel RealSense ROS wrapper following instructions:  
  [RealSense ROS wrapper](https://github.com/IntelRealSense/realsense-ros)
  
- Clone project from into '~/ros2_ws/src/':
  ```bash
  git clone <URL>
  cd ~/ros2_ws # Return to workspace root before building
  ```

- Install dependencies:
   ```bash
   sudo apt-get install python3-rosdep -y
   sudo rosdep init
   rosdep update
   rosdep install --from-paths src --ignore-src -r -y
   ```
   
- Build:
  ```bash
  colcon build --symlink-install
  ```

### Structure
- **main_package**: Contains launch file that can be used to launch the system in one terminal.
- **realsense-ros**: Contains drivers and tools for Intel RealSense cameras.
- **pose_estimation**: Contains keypoint detection and pose estimation logic.
- **pose_monitoring**: Contains pose stability tracking and feasibility checks.
- **motion_executor**: Handles main logic for system.
- **robot_controller_py**: Handles communication with the robot and gripper.
- **visualization**: Provides tools for visualizing poses.
- **interfaces**: Custom interfaces.
- **resources**: Contains config with system parameters such as camera intrinsics, TCPs, etc.

### Running the system
To run the system, start by sourcing the workspace:
```bash
cd ~/ros2_ws
source install/setup.bash
```
The next step is to launch the camera:
```bash
ros2 launch realsense2_camera rs_launch.py camera_namespace:=camera camera_name:=d435i enable_rgbd:=true enable_sync:=true align_depth.enable:=true rgb_camera.color_profile:=640x480x30 depth_module.depth_profile:=640x480x30 enable_color:=true enable_depth:=true
```
There are two ways of launching the other parts of the system:
#### Option 1 | One terminal:
The first option is to launch the system using only one terminal.
```bash
ros2 launch main_package project_launch.py
```
#### Option 2 | Multiple terminals:
The second way is to launch each "subsystem" independent of eachother in different terminals:
- Terminal 1:
  ```bash
  ros2 launch pose_estimation pose_estimation_launch.py
  ```
- Terminal 2:
  ```bash
  ros2 launch robot_controller_py robot_controller_launch.py
  ```
- Terminal 3:
  ```bash
  ros2 launch motion_executor motion_executor_launch.py
  ```
- Terminal 4:
  ```bash
  ros2 launch visualization visualization_launch.py
  ```
- Terminal 5:
  ```bash
  ros2 launch pose_monitoring pose_monitoring_launch.py
  ```
The upside to launching the system in multiple terminals is that it's easier to interpret messages, warnings and errors generated by the system.
### Parameters
For the full list of parameters use `ros2 param list`
For the entire list of parameters type `ros2 param list`.
For reading a parameter value use `ros2 param get <node> <parameter_name>` 
For setting a new value for a parameter use `ros2 param set <node> <parameter_name> <value>`
- **pose_estimation**:
  - debug (default: false): If set to true enables extra messages for debugging purposes.
- **pose_monitoring**:
  - auto (default: true): If set to true automatic mode is enabled and the stability tracker is used to determine when to trigger a pick sequence. If set to false, then the trigger service can be called manually with:
    ```bash
    ros2 service call /robot/trigger interfaces/srv/TriggerPickSequence
    ```
  - debug (default: false): Default is false, if set to true enables extra messages for debugging purposes.
- **robot_controller_py**:
  - ip (default: "192.168.1.102"): Ip of robot and gripper.
  - port (default: 63352): Port of gripper where 63352 is the default used by Robotiq grippers.
  - force (default: 50): Force used by the gripper.
- **visualization**:
  - keypoints (default: true): Enables the visualization of keypoints. 
  - estimations (default: true): Enables the visualization of estimations.
  - feasible (default: true): Enables the visualization of feasibility filter. 
